machine:
  php:
    version: 7.1.3
  environment:
      SYMFONY_ENV: test

checkout:
  post:
    - git clone git@github.com:Alsciende/fiveringsdb.git /home/ubuntu/fiveringsdb
    - cp /home/ubuntu/fiveringsdb/vue/config/prod.env.js.dist /home/ubuntu/fiveringsdb/vue/config/prod.env.js

dependencies:
  pre:
    - cp /home/ubuntu/fiveringsdb/app/config/parameters.circle.yml /home/ubuntu/fiveringsdb/app/config/parameters.yml
  post:
    - sudo cp /home/ubuntu/fiveringsdb/app/config/apache.circle.conf /etc/apache2/sites-available/fiveringsdb.conf
    - sudo rm /etc/apache2/mods-enabled/php5.load
    - sudo a2ensite fiveringsdb
    - sudo service apache2 restart

database:
  post:
    - cd /home/ubuntu/fiveringsdb && bin/console doctrine:schema:update --no-interaction  --force
    - cd /home/ubuntu/fiveringsdb && bin/console doctrine:fixtures:load --no-interaction
    - cd /home/ubuntu/fiveringsdb && bin/console app:data:import --no-interaction

test:
  override:
    - cd /home/ubuntu/fiveringsdb && phpunit -d memory_limit=128M --verbose --debug

deployment:
  production:
    branch: master
    commands:
      - ./deploy.sh
